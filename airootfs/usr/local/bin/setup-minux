#!/bin/bash
set -e

echo "Checking network..."

HOST="8.8.8.8"
PING_COUNT=2

if ping -c "$PING_COUNT" "$HOST" > /dev/null 2>&1; then
    echo "Network OK. Starting MINUX installation..."

    archinstall --config /usr/share/minux.json || {
        echo "archinstall failed. Exiting..."
        exit 1
    }

    echo "Detecting installed root partition..."

    CONFIG_PATH="/var/log/archinstall/user_configuration.json"

    if ! [[ -f "$CONFIG_PATH" ]]; then
        echo "$CONFIG_PATH not found."
        exit 1
    fi

    # Extract root disk and find root partition (assuming 2nd partition = /)
    ROOT_DISK=$(jq -r '.disk_config.device_modifications[0].device' "$CONFIG_PATH")
    ROOT_PART="$ROOT_DISK"2

    echo "Detected root partition: $ROOT_PART"

    # Mount root partition
    mount "$ROOT_PART" /mnt

    # Mount essential filesystems
    mount --bind /dev /mnt/dev
    mount --bind /proc /mnt/proc
    mount --bind /sys /mnt/sys

    # Mount /boot if defined
    BOOT_PART="$ROOT_DISK"1
    mkdir -p /mnt/boot
    mount "$BOOT_PART" /mnt/boot

    echo "Running setup script inside chroot..."
    SCRIPT_DIR="/root/minux_scripts"

    arch-chroot /mnt bash -c "
        pacman -Syu --noconfirm git &&
        git clone https://github.com/kuper0201/minux_ml_scripts $SCRIPT_DIR &&
        cd $SCRIPT_DIR &&
        ./setup.sh &&
        rm -rf $SCRIPT_DIR
    "

    read -rp $'\nDo you want to enter chroot for manual setting? [y/N]: ' answer
    answer=${answer,,}

    if [[ "$answer" == "y" || "$answer" == "yes" ]]; then
        arch-chroot /mnt bash
    else
        echo "Installation complete. Unmounting..."
        umount -R /mnt
    fi

else
    echo -e "\nMINUX installer requires an active network connection."
    echo "Please check your connection and try again."
    exit 1
fi
