#!/bin/bash
set -e

echo "Checking network..."

HOST="8.8.8.8"
PING_COUNT=2

if ping -c "$PING_COUNT" "$HOST" > /dev/null 2>&1; then
    echo "Network OK. Starting MINUX installation..."

    archinstall --config /usr/share/minux.json || {
        echo "archinstall failed. Exiting..."
        exit 1
    }

    echo "Trying to find installed root partition from archinstall log..."

    # 1. 로그에서 루트 파티션 찾기
    INSTALL_LOG="/tmp/archinstall.log"
    ROOT_PART=""

    if [[ -f "$INSTALL_LOG" ]]; then
        ROOT_PART=$(grep -Po '/dev/\w+\d+' "$INSTALL_LOG" | head -n 1)
    fi

    if [[ -z "$ROOT_PART" ]]; then
        echo "Failed to detect root partition. Please mount manually."
        exit 1
    fi

    echo "Detected root partition: $ROOT_PART"

    # 2. 루트 파티션 마운트
    mount "$ROOT_PART" /mnt

    # 3. 필요한 시스템 디렉토리 마운트
    mount --bind /dev /mnt/dev
    mount --bind /proc /mnt/proc
    mount --bind /sys /mnt/sys

    # (옵션) EFI 파티션도 필요한 경우 마운트
    if grep -q '/boot/efi' "$INSTALL_LOG"; then
        EFI_PART=$(grep -Po '/dev/\w+\d+' "$INSTALL_LOG" | sed -n '2p')
        mkdir -p /mnt/boot/efi
        mount "$EFI_PART" /mnt/boot/efi
        echo "Mounted EFI partition: $EFI_PART"
    fi

    echo "Running setup script inside chroot..."
    SCRIPT_DIR="/root/minux_scripts"

    arch-chroot /mnt bash -c "
        pacman -Syu --noconfirm git &&
        git clone https://github.com/kuper0201/minux_ml_scripts $SCRIPT_DIR &&
        cd $SCRIPT_DIR &&
        ./setup.sh &&
        rm -rf $SCRIPT_DIR
    "

    read -rp $'\nDo you want to enter chroot for manual setting? [y/N]: ' answer
    answer=${answer,,}

    if [[ "$answer" == "y" || "$answer" == "yes" ]]; then
        arch-chroot /mnt bash
    else
        echo "Installation complete. Unmounting and exiting."

        umount -R /mnt
    fi
else
    echo -e "\nMINUX installer requires an active network connection."
    echo "Please check your connection and try again."
    exit 1
fi
